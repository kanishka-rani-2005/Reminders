import os
import time
import requests

# ==========================================
# CONFIGURATION
# ==========================================
HEYGEN_API_KEY = os.getenv("HEYGEN_API_KEY", "sk_V2_hgu_kxLruCQ2C0a_mDsDfxQfiirKohMpJ26PXDz1q4P0YAo0")

OUTPUT_DIR = "output/base_videos"
os.makedirs(OUTPUT_DIR, exist_ok=True)

AVATAR_ID = "Adriana_Business_Front_public"

LANG_VOICE = {
    "hindi": {"voice_id": "dcf69bbbab5b41f2b75b9f86316c06c5"},
    "tamil": {"voice_id": "f37bfc7d0be8494c8fa103a4a47eed33"},
    "telugu": {"voice_id": "8b06642340ad474e8d32b040928fe459"},
    "kannada": {"voice_id": "7d7d4ebc1c164e71a0542ecab97fdb43"},
}

# ==========================================
# LONGEST NAME + BIGGEST EMI EXAMPLES
# ==========================================
CUSTOMER_EXAMPLE = {
    "hindi": {
        "customer_name": "KHAN MOHAMMED AHMAR AMAN TOHID",
        "loan_number": "SF987654321",
        "sanctioned_amount": "тВ╣17,62,547",
        "emi_amount": "тВ╣72,183.00",
        "emi_due": "05 рдирд╡рдореНрдмрд░ 2025",
        "account_last4": "4521",
        "bank_ifsc": "HDFC0001234",
    },
    "tamil": {
        "customer_name": "THAMIZHARASAN DHAMODHARAN DHAMODHARAN",
        "loan_number": "SF546372819",
        "sanctioned_amount": "тВ╣17,62,547",
        "emi_amount": "тВ╣72,183.00",
        "emi_due": "05 роиро╡роорпНрокро░рпН 2025",
        "account_last4": "3928",
        "bank_ifsc": "ICIC0005678",
    },
    "telugu": {
        "customer_name": "MEDIDA VEERA VENKATA SATYANARAYANA",
        "loan_number": "SF234891002",
        "sanctioned_amount": "тВ╣17,62,547",
        "emi_amount": "тВ╣72,183.00",
        "emi_due": "05 р░ир░╡р░Вр░мр░░р▒Н 2025",
        "account_last4": "9710",
        "bank_ifsc": "SBI0007894",
    },
    "kannada": {
        "customer_name": "SURESH KORAGALL YANKAPPA KORAGALL",
        "loan_number": "SF192837465",
        "sanctioned_amount": "тВ╣17,62,547",
        "emi_amount": "тВ╣72,183.00",
        "emi_due": "05 р▓ир▓╡р│Жр▓Вр▓мр▓░р│Н 2025",
        "account_last4": "2845",
        "bank_ifsc": "KKBK0004567",
    },
}

# ==========================================
# LANGUAGE TEXTS (LOCALIZED)
# ==========================================

TEMPLATES = {
    "hindi": """рдирдорд╕реНрддреЗ, рдореИрдВ рд╕рд╛рд░рдереА рдлрд╛рдЗрдиреЗрдВрд╕ рд╕реЗ рдЖрдкрдХреА рд╡рд┐рддреНрддреАрдп рд╕рд╣рд╛рдпрдХ рдмреЛрд▓ рд░рд╣реА рд╣реВрдБред

рдкреНрд░рд┐рдп {customer_name}, рдЖрдкрдХрд╛ рд▓реЛрди рдирдВрдмрд░ {loan_number} рд╣реИ, рдЬрд┐рд╕рдХреА рд╕реНрд╡реАрдХреГрдд рд░рд╛рд╢рд┐ {sanctioned_amount} рд╣реИред
рдЖрдкрдХреА рдорд╛рд╕рд┐рдХ рдИрдПрдордЖрдИ {emi_amount} рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХреА рдЧрдИ рд╣реИ, рдЬрд┐рд╕рдХреА рдЕрдЧрд▓реА рджреЗрдп рддрд┐рдерд┐ {emi_due} рд╣реИред

рдЖрдкрдХрд╛ рдмреИрдВрдХ рдЦрд╛рддрд╛, рдЬрд┐рд╕рдХрд╛ рдЕрдВрддрд┐рдо рдЪрд╛рд░ рдЕрдВрдХ {account_last4} рд╣реИрдВ, рдФрд░ IFSC рдХреЛрдб {bank_ifsc} рд╣реИ, рд╕реЗ рдпрд╣ рд░рд╛рд╢рд┐ рд╕реНрд╡рддрдГ рдХрд╛рдЯреА рдЬрд╛рдПрдЧреАред
рдХреГрдкрдпрд╛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдЖрдкрдХреЗ рдЦрд╛рддреЗ рдореЗрдВ рдкрд░реНрдпрд╛рдкреНрдд рдзрдирд░рд╛рд╢рд┐ рдмрдиреА рд░рд╣реЗ рддрд╛рдХрд┐ рднреБрдЧрддрд╛рди рдореЗрдВ рдХреЛрдИ рд░реБрдХрд╛рд╡рдЯ рди рд╣реЛред

рдпрджрд┐ рднреБрдЧрддрд╛рди рд╡рд┐рд▓рдВрдмрд┐рдд рд╣реЛрддрд╛ рд╣реИ, рддреЛ тВ╣500 рдкреНрд▓рд╕ рдЬреАрдПрд╕рдЯреА рдХрд╛ рд╢реБрд▓реНрдХ рдФрд░ 2% рдорд╛рд╕рд┐рдХ рдмреНрдпрд╛рдЬ рдЬреБрдбрд╝ рдЬрд╛рдПрдЧрд╛ред
рдмрд╛рд░-рдмрд╛рд░ рджреЗрд░реА рд╣реЛрдиреЗ рдкрд░ рдЖрдкрдХрд╛ рдХреНрд░реЗрдбрд┐рдЯ рд╕реНрдХреЛрд░ рдкреНрд░рднрд╛рд╡рд┐рдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

рд╕рд╛рд░рдереА рдлрд╛рдЗрдиреЗрдВрд╕ рдкрд░ рднрд░реЛрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдзрдиреНрдпрд╡рд╛рдж тАФ рд╣рдо рдЖрдкрдХреЗ рд╣рд░ рд╡рд┐рддреНрддреАрдп рдХрджрдо рдкрд░ рдЖрдкрдХреЗ рд╕рд╛рде рд╣реИрдВред
""",

    "tamil": """ро╡рогроХрпНроХроорпН, роиро╛ройрпН роЪро╛ро░родро┐ рокрпИройро╛ройрпНро╕рпН роиро┐ро▒рпБро╡ройродрпНродро┐ро▓ро┐ро░рпБроирпНродрпБ роЙроЩрпНроХро│рпН роиро┐родро┐ роЙродро╡ро┐ропро╛ро│ро░рпН рокрпЗроЪрпБроХро┐ро▒рпЗройрпН.

роЕройрпНрокро┐ро▒рпНроХро┐ройро┐роп {customer_name}, роЙроЩрпНроХро│рпН роХроЯройрпН роОрогрпН {loan_number}, роорпКродрпНрод родрпКроХрпИ {sanctioned_amount} роЖроХ роЕроЩрпНроХрпАроХро░ро┐роХрпНроХрокрпНрокроЯрпНроЯрпБро│рпНро│родрпБ.
роЙроЩрпНроХро│рпН рооро╛род родро╡рогрпИ родрпКроХрпИ {emi_amount} роЖроХрпБроорпН, роЕроЯрпБродрпНрод роХроЯрпНроЯрогроорпН {emi_due} роЕройрпНро▒рпБ ро╡ро░ро╡рпБро│рпНро│родрпБ.

роЙроЩрпНроХро│рпН ро╡роЩрпНроХро┐ роХрогроХрпНроХрпБ ({account_last4}) рооро▒рпНро▒рпБроорпН IFSC {bank_ifsc} роорпВро▓рооро╛роХ родрпКроХрпИ родро╛ройро╛роХ рокро┐роЯро┐роХрпНроХрокрпНрокроЯрпБроорпН.
родрпКроХрпИ роХрпБро▒рпИро╡ро╛роХ роЗро░рпБроирпНродро╛ро▓рпН роХроЯрпНроЯрогроорпН родрпЛро▓рпНро╡ро┐ропроЯрпИропрпБроорпН роОройрпНрокродро╛ро▓рпН рокрпЛродрпБрооро╛рой роЗро░рпБрокрпНрокрпБ ро╡рпИродрпНродро┐ро░рпБроЩрпНроХро│рпН.

роХроЯрпНроЯрогроорпН родро╛роородрооро╛ройро╛ро▓рпН тВ╣500 + ро╡ро░ро┐ рооро▒рпНро▒рпБроорпН 2% рооро╛род ро╡роЯрпНроЯро┐ роХроЯрпНроЯрогроорпН ро╡ро┐родро┐роХрпНроХрокрпНрокроЯрпБроорпН.
родрпКроЯро░рпНроЪрпНроЪро┐ропро╛рой родро╛роородроорпН роЙроЩрпНроХро│рпН роХроЯройрпН роородро┐рокрпНрокрпЖрогрпН роХрпБро▒рпИропроХрпНроХрпВроЯрпБроорпН.

роЪро╛ро░родро┐ рокрпИройро╛ройрпНро╕рпН тАФ роЙроЩрпНроХро│рпН роироорпНрокро┐роХрпНроХрпИроХрпНроХрпБ роиройрпНро▒ро┐. роиро╛роЩрпНроХро│рпН роОрокрпНрокрпЛродрпБроорпН роЙроЩрпНроХро│рпБроЯройрпН роЗро░рпБроХрпНроХро┐ро▒рпЛроорпН.
""",

    "telugu": """р░ир░ор░╕р▒Нр░Хр░╛р░░р░В, р░ир▒Зр░ир▒Б р░╕р░╛р░░р░ер░┐ р░лр▒Ир░ир░╛р░ир▒Нр░╕р▒Н р░ир▒Бр░Вр░бр░┐ р░ор▒А р░Жр░░р▒Нр░ер░┐р░Х р░╕р░╣р░╛р░пр░Хр▒Бр░░р░╛р░▓р░┐р░ир░┐.

р░кр▒Нр░░р░┐р░пр░ор▒Ир░и {customer_name}, р░ор▒А р░░р▒Бр░г р░ир░Вр░мр░░р▒Н {loan_number}, р░ор▒Кр░др▒Нр░др░В р░░р▒Бр░гр░В {sanctioned_amount} р░ор░Вр░Ьр▒Вр░░р▒Б р░Ър▒Зр░пр░мр░бр░┐р░Вр░жр░┐.
р░ор▒А р░ир▒Жр░▓р░╡р░╛р░░р▒А EMI {emi_amount}, р░Ър▒Жр░▓р▒Нр░▓р░┐р░Вр░кр▒Б р░др▒Зр░жр░┐ {emi_due}.

р░ор▒А р░мр▒Нр░пр░╛р░Вр░Хр▒Н р░Цр░╛р░др░╛ р░Ър░┐р░╡р░░р░┐ р░ир░╛р░▓р▒Бр░Чр▒Б р░Ер░Вр░Хр▒Жр░▓р▒Б {account_last4}, IFSC {bank_ifsc} р░ир▒Бр░Вр░бр░┐ р░Жр░Яр▒Лр░ор▒Зр░Яр░┐р░Хр▒НтАМр░Чр░╛ р░бр▒Жр░мр░┐р░Яр▒Н р░Ер░╡р▒Бр░др▒Бр░Вр░жр░┐.
р░жр░пр░Ър▒Зр░╕р░┐ р░Цр░╛р░др░╛р░▓р▒Л р░др░Чр░┐р░ир░Вр░д р░ир░┐р░зр▒Бр░▓р▒Б р░Йр░Вр░Ър░Вр░бр░┐.

р░╡р░╛р░пр░┐р░жр░╛ р░Жр░▓р░╕р▒Нр░пр░В р░Ер░пр░┐р░др▒З тВ╣500 р░ор░░р░┐р░пр▒Б GST р░Ър░╛р░░р▒Нр░Ьр▒Н р░Ер░▓р░╛р░Чр▒З 2% р░ир▒Жр░▓ р░╡р░бр▒Нр░бр▒А р░╡р░░р▒Нр░др░┐р░╕р▒Нр░др▒Бр░Вр░жр░┐.
р░кр▒Бр░ир░░р░╛р░╡р▒Гр░др░ор▒Ир░и р░Жр░▓р░╕р▒Нр░пр░В р░ор▒А р░Хр▒Нр░░р▒Жр░бр░┐р░Яр▒Н р░╕р▒Нр░Хр▒Лр░░р▒НтАМр░кр▒И р░кр▒Нр░░р░нр░╛р░╡р░В р░Ър▒Вр░кр▒Бр░др▒Бр░Вр░жр░┐.

р░╕р░╛р░░р░ер░┐ р░лр▒Ир░ир░╛р░ир▒Нр░╕р▒НтАМр░кр▒И р░ир░ор▒Нр░ор░Хр░╛р░ир░┐р░Хр░┐ р░зр░ир▒Нр░пр░╡р░╛р░жр░╛р░▓р▒Б тАФ р░ор▒А р░кр▒Нр░░р░др░┐ р░Жр░░р▒Нр░ер░┐р░Х р░Ер░бр▒Бр░Чр▒Бр░▓р▒Л р░ор▒Зр░ор▒Б р░ор▒Ар░др▒Л р░Йр░Вр░Яр░╛р░ор▒Б.
""",

    "kannada": """р▓ир▓ор▓╕р│Нр▓Хр▓╛р▓░, р▓ир▓╛р▓ир│Б р▓╕р▓╛р▓░р▓ер▓┐ р▓лр│Ир▓ир▓╛р▓ир│Нр▓╕р│НтАМр▓ир▓┐р▓Вр▓ж р▓ир▓┐р▓ор│Нр▓о р▓╣р▓гр▓Хр▓╛р▓╕р│Б р▓╕р▓╣р▓╛р▓пр▓Хр▓┐р▓пр▓╛р▓Чр▓┐ р▓ор▓╛р▓др▓ир▓╛р▓бр│Бр▓др│Нр▓др▓┐р▓жр│Нр▓жр│Зр▓ир│Ж.

р▓кр│Нр▓░р▓┐р▓п {customer_name}, р▓ир▓┐р▓ор│Нр▓о р▓╕р▓╛р▓▓ р▓╕р▓Вр▓Цр│Нр▓пр│Ж {loan_number}, р▓ор▓Вр▓Ьр│Вр▓░р▓╛р▓ж р▓ор│Кр▓др│Нр▓д {sanctioned_amount}.
р▓ир▓┐р▓ор│Нр▓о р▓ор▓╛р▓╕р▓┐р▓Х р▓Зр▓Ор▓Вр▓Р {emi_amount}, р▓кр▓╛р▓╡р▓др▓┐ р▓жр▓┐р▓ир▓╛р▓Вр▓Х {emi_due} р▓Жр▓Чр▓┐р▓жр│Ж.

р▓ир▓┐р▓ор│Нр▓о р▓мр│Нр▓пр▓╛р▓Вр▓Хр│Н р▓Цр▓╛р▓др│Ж ({account_last4}) р▓ор▓др│Нр▓др│Б IFSC р▓Хр│Лр▓бр│Н {bank_ifsc} р▓ор│Вр▓▓р▓Х р▓ор│Кр▓др│Нр▓др▓╡р▓ир│Нр▓ир│Б р▓╕р│Нр▓╡р▓пр▓В р▓Хр▓Яр│Н р▓ор▓╛р▓бр▓▓р▓╛р▓Чр│Бр▓др│Нр▓др▓жр│Ж.
р▓жр▓пр▓╡р▓┐р▓Яр│Нр▓Яр│Б р▓Цр▓╛р▓др│Жр▓пр▓▓р│Нр▓▓р▓┐ р▓Ер▓Чр▓др│Нр▓пр▓╡р▓┐р▓░р│Бр▓╡ р▓ор│Кр▓др│Нр▓др▓╡р▓ир│Нр▓ир│Б р▓Зр▓░р▓┐р▓╕р▓┐.

р▓кр▓╛р▓╡р▓др▓┐ р▓др▓бр▓╡р▓╛р▓жр▓░р│Ж тВ╣500 + р▓Ьр▓┐р▓Ор▓╕р│НтАМр▓Яр▓┐ р▓╣р▓╛р▓Чр│В р▓кр│Нр▓░р▓др▓┐ р▓др▓┐р▓Вр▓Чр▓│р│Б 2% р▓мр▓бр│Нр▓бр▓┐ р▓╡р▓┐р▓зр▓┐р▓╕р▓▓р▓╛р▓Чр│Бр▓др│Нр▓др▓жр│Ж.
р▓ор▓░р│Бр▓ор▓░р│Б р▓др▓бр▓╡р▓╛р▓жр▓░р│Ж р▓ир▓┐р▓ор│Нр▓о р▓Хр│Нр▓░р│Жр▓бр▓┐р▓Яр│Н р▓╕р│Нр▓Хр│Лр▓░р│Н р▓╣р▓╛р▓ир▓┐р▓пр▓╛р▓Чр▓мр▓╣р│Бр▓жр│Б.

р▓╕р▓╛р▓░р▓ер▓┐ р▓лр│Ир▓ир▓╛р▓ир│Нр▓╕р│Н тАФ р▓ир▓┐р▓ор│Нр▓о р▓╡р▓┐р▓╢р│Нр▓╡р▓╛р▓╕р▓Хр│Нр▓Хр│Ж р▓зр▓ир│Нр▓пр▓╡р▓╛р▓жр▓Чр▓│р│Б. р▓ир▓╛р▓╡р│Б р▓пр▓╛р▓╡р▓╛р▓Чр▓▓р│В р▓ир▓┐р▓ор│Нр▓о р▓Ьр│Кр▓др│Жр▓Чр▓┐р▓жр│Нр▓жр│Зр▓╡р│Ж.
""",
}

# ==========================================
# CREATE VIDEO
# ==========================================
def generate_video(lang, text, voice_id):
    url = "https://api.heygen.com/v2/video/generate"
    headers = {
        "Authorization": f"Bearer {HEYGEN_API_KEY}",
        "Content-Type": "application/json"
    }

    payload = {
        "video_inputs": [
            {
                "character": {
                    "type": "avatar",
                    "avatar_id": AVATAR_ID,
                    "avatar_style": "normal"
                },
                "voice": {
                    "type": "text",
                    "input_text": text,
                    "voice_id": voice_id,
                    "speed": 1.25
                }
            }
        ],
        "dimension": {"width": 1280, "height": 720}
    }

    response = requests.post(url, headers=headers, json=payload)
    if response.status_code != 200:
        print(f"тЭМ Failed for {lang}: {response.status_code} - {response.text}")
        return None

    result = response.json()
    video_id = result.get("data", {}).get("video_id")
    if not video_id:
        print(f"тЪая╕П No video ID returned for {lang}: {result}")
        return None

    print(f"тЬЕ {lang.capitalize()} video request created! Video ID: {video_id}")
    return video_id


# ==========================================
# POLL STATUS AND DOWNLOAD (v2 FIXED)
# ==========================================
def download_video(video_id, lang):
    status_url = f"https://api.heygen.com/v1/video/status?video_id={video_id}"
    headers = {"Authorization": f"Bearer {HEYGEN_API_KEY}"}

    print(f"тП│ Waiting for {lang} video to render...")

    for attempt in range(60):  # up to 10 minutes
        time.sleep(10)
        try:
            r = requests.get(status_url, headers=headers, timeout=15)
            if r.status_code != 200:
                print(f"тЪая╕П [{lang}] Status check failed ({r.status_code}), retrying...")
                continue

            data = r.json().get("data", {})
            status = data.get("status")
            video_url = data.get("video_url")

            print(f"ЁЯФН [{lang}] Attempt {attempt+1}/60 тЖТ status: {status}")

            # тЬЕ If video_url available (even if status says 'failed'), download it
            if video_url:
                output_path = os.path.join(OUTPUT_DIR, f"{lang}.mp4")
                print(f"тмЗя╕П [{lang}] Downloading from {video_url} ...")
                try:
                    video_data = requests.get(video_url, timeout=30).content
                    with open(output_path, "wb") as f:
                        f.write(video_data)
                    print(f"тЬЕ [{lang}] Video saved successfully тЖТ {output_path}")
                except Exception as e:
                    print(f"тЪая╕П [{lang}] Download issue: {e}")
                return

        except Exception as e:
            print(f"тЪая╕П [{lang}] Network or JSON issue: {e}")
            time.sleep(5)

    print(f"тЪая╕П [{lang}] Timeout: video not ready even after 10 minutes.")


# ==========================================
# MAIN EXECUTION
# ==========================================
if __name__ == "__main__":
    for lang, customer in CUSTOMER_EXAMPLE.items():
        text = TEMPLATES[lang].format(**customer)
        voice_id = LANG_VOICE[lang]["voice_id"]
        print(f"ЁЯОм Generating {lang} base video...")
        video_id = generate_video(lang, text, voice_id)
        if video_id:
            download_video(video_id, lang)
