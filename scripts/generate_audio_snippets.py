import pandas as pd
import os
import requests

# ==================================================
# ЁЯЧгя╕П STEP 1: Generate Speech Function
# ==================================================
def generate_speech(text, lang_code, output_path):
    ELEVEN_API_KEY = "sk_f69d64ab5822565596479fab3500a503cf72a50a133794ba"   # Replace safely
    MODEL_ID = "eleven_multilingual_v2"
    VOICE_ID = "21m00Tcm4TlvDq8ikWAM"  # Multilingual voice

    url = f"https://api.elevenlabs.io/v1/text-to-speech/{VOICE_ID}"

    headers = {
        "Accept": "audio/mpeg",
        "Content-Type": "application/json",
        "xi-api-key": ELEVEN_API_KEY,
    }

    payload = {
        "text": text,
        "model_id": MODEL_ID,
        "voice_settings": {"stability": 0.4, "similarity_boost": 0.8},
    }

    response = requests.post(url, headers=headers, json=payload)

    if response.status_code == 200:
        with open(output_path, "wb") as f:
            f.write(response.content)
        print(f"тЬЕ Saved: {output_path}")
    else:
        print(f"тЭМ Error {response.status_code}: {response.text}")


# ==================================================
# ЁЯТм STEP 2: Two-sentence dynamic text
# ==================================================
def make_two_segments(row):
    name = row["name"]
    loan_no = row["loan_account_number"]
    loan_amount = row["loan_amount"]
    emi_amount = row["emi_amount"]
    due_date = row["due_date"]
    ifsc = row["ifsc"]
    last4 = str(row.get("account_last4", "XXXX"))
    lang = row["language"].strip().lower()

    templates = {
        "hindi": [
            f"рдкреНрд░рд┐рдп {name}, рдЖрдкрдХрд╛ рд▓реЛрди рдирдВрдмрд░ {loan_no} рд╣реИ, рдЬрд┐рд╕рдХреА рд╕реНрд╡реАрдХреГрдд рд░рд╛рд╢рд┐ {loan_amount} рд╣реИред",
            f" рдЖрдкрдХреА рдорд╛рд╕рд┐рдХ рдИрдПрдордЖрдИ {emi_amount} рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХреА рдЧрдИ рд╣реИ, рдЬрд┐рд╕рдХреА рдЕрдЧрд▓реА рджреЗрдп рддрд┐рдерд┐ {due_date} рд╣реИред рдЖрдкрдХрд╛ рдмреИрдВрдХ рдЦрд╛рддрд╛, рдЬрд┐рд╕рдХрд╛ рдЕрдВрддрд┐рдо рдЪрд╛рд░ рдЕрдВрдХ {last4} рд╣реИрдВ, рдФрд░ IFSC рдХреЛрдб {ifsc} рд╣реИ, рд╕реЗ рдпрд╣ рд░рд╛рд╢рд┐ рд╕реНрд╡рддрдГ рдХрд╛рдЯреА рдЬрд╛рдПрдЧреАред"
        ],

        "tamil": [
            f"роЕройрпНрокрпБроЯрпИропрпАро░рпН {name}, роЙроЩрпНроХро│рпН роХроЯройрпН роОрогрпН {loan_no}, роХроЯройрпН родрпКроХрпИ {loan_amount} ро░рпВрокро╛ропрпН.",
            f" рооро╛родро╛роирпНродро┐ро░ EMI {emi_amount} ро░рпВрокро╛ропрпН, роХроЯрпИроЪро┐ родрпЗродро┐ {due_date}. роЙроЩрпНроХро│рпН ро╡роЩрпНроХро┐ роХрогроХрпНроХрпБ (роХроЯрпИроЪро┐ роиро╛ройрпНроХрпБ роЗро▓роХрпНроХроЩрпНроХро│рпН {last4}) рооро▒рпНро▒рпБроорпН IFSC роХрпБро▒ро┐ропрпАроЯрпБ {ifsc} роЗро▓ро┐ро░рпБроирпНродрпБ роЗроирпНрод родрпКроХрпИ родро╛ройро╛роХроХрпН роХро┤ро┐роХрпНроХрокрпНрокроЯрпБроорпН."
        ],

        "telugu": [
            f"р░кр▒Нр░░р░┐р░пр░ор▒Ир░и {name}, р░ор▒А р░░р▒Бр░г р░╕р░Вр░Цр▒Нр░п {loan_no}, р░ор▒Кр░др▒Нр░др░В {loan_amount} р░░р▒Вр░кр░╛р░пр░▓р▒Б.",
            f" р░ор▒А EMI {emi_amount} р░░р▒Вр░кр░╛р░пр░▓р▒Б, р░Чр░бр▒Бр░╡р▒Б р░др▒Зр░жр▒А {due_date}. р░ор▒А р░мр▒Нр░пр░╛р░Вр░Хр▒Н р░Цр░╛р░др░╛ р░Ър░┐р░╡р░░р░┐ р░ир░╛р░▓р▒Бр░Чр▒Б р░Ер░Вр░Хр▒Жр░▓р▒Б {last4}, IFSC р░Хр▒Лр░бр▒Н {ifsc} р░ир▒Бр░Вр░бр░┐ р░И р░ор▒Кр░др▒Нр░др░В р░╕р▒Нр░╡р░пр░Вр░Чр░╛ р░др▒Ар░╕р▒Бр░Хр▒Лр░мр░бр▒Бр░др▒Бр░Вр░жр░┐."
        ],

        "kannada": [
            f"р▓Жр▓жр▓░р▓ир│Ар▓п {name}, р▓ир▓┐р▓ор│Нр▓о р▓╕р▓╛р▓▓ р▓╕р▓Вр▓Цр│Нр▓пр│Ж {loan_no}, р▓╕р▓╛р▓▓ р▓ор│Кр▓др│Нр▓д {loan_amount} р▓░р│Вр▓кр▓╛р▓пр▓┐.",
            f" р▓ир▓┐р▓ор│Нр▓о р▓Зр▓Ор▓Вр▓Р {emi_amount} р▓░р│Вр▓кр▓╛р▓пр▓┐ р▓Жр▓Чр▓┐р▓жр│Нр▓жр│Б, р▓кр▓╛р▓╡р▓др▓┐ р▓жр▓┐р▓ир▓╛р▓Вр▓Х {due_date}. р▓ир▓┐р▓ор│Нр▓о р▓мр│Нр▓пр▓╛р▓Вр▓Хр│Н р▓Цр▓╛р▓др│Жр▓п р▓Хр│Кр▓ир│Жр▓п р▓ир▓╛р▓▓р│Нр▓Хр│Б р▓Ер▓Вр▓Хр│Жр▓Чр▓│р│Б {last4}, IFSC р▓Хр│Лр▓бр│Н {ifsc} р▓Зр▓Вр▓ж р▓И р▓ор│Кр▓др│Нр▓д р▓╕р│Нр▓╡р▓пр▓Вр▓Ър▓╛р▓▓р▓┐р▓др▓╡р▓╛р▓Чр▓┐ р▓Хр▓бр▓┐р▓др▓Чр│Кр▓│р│Нр▓│р│Бр▓др│Нр▓др▓жр│Ж."
        ],

        "english": [
            f"Dear {name}, your loan number is {loan_no} with a sanctioned amount of {loan_amount} rupees.",
            f" Your monthly EMI is {emi_amount}, due on {due_date}. The amount will be auto-debited from your bank account ending with {last4}, having IFSC code {ifsc}."
        ],
    }

    return templates.get(lang, templates["english"]), lang


# ==================================================
# ЁЯзй STEP 3: Process CSV and Generate 2 Audio Clips
# ==================================================
def process_csv(csv_path, output_dir="output_2clips"):
    os.makedirs(output_dir, exist_ok=True)
    df = pd.read_csv(csv_path)

    for _, row in df.iterrows():
        segments, lang = make_two_segments(row)
        cid = str(row["id"])
        customer_dir = os.path.join(output_dir, f"{cid}_{lang}")
        os.makedirs(customer_dir, exist_ok=True)

        print(f"\nЁЯОЩя╕П Generating 2 audio clips for {row['name']} ({lang})...")

        for i, text in enumerate(segments, start=1):
            file_path = os.path.join(customer_dir, f"{i:02d}_{lang}.mp3")
            generate_speech(text, lang, file_path)


# ==================================================
# ЁЯЪА MAIN
# ==================================================
if __name__ == "__main__":
    process_csv("data/customers_master_spoken.csv")
